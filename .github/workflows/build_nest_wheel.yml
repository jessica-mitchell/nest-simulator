name: Build NEST simulator wheels

on:
  release:
    types: [published]
  workflow_dispatch:
  # Trigger on pull requests and pushes to main branches for testing
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ master, hep_pynest-ng ]

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15, macos-15-intel, macos-latest, ubuntu-24.04]
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        with:
          package-dir: .
          output-dir: wheelhouse

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        run: pipx run build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-sdist
          path: dist/*.tar.gz

  upload_pypi:
    name: Upload wheels to pypi
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      id-token: write
    if: (github.event_name == 'release' && github.event.action == 'published') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/download-artifact@v4
        with:
          # unpacks all CIBW artifacts into dist/
          pattern: cibw-*
          path: dist
          merge-multiple: true

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: false
          verbose: true
          # only for test pypi
          repository-url: https://test.pypi.org/legacy/


  test_macos_specific:
    name: Test macOS-specific functionality
    needs: [upload_pypi]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15, macos-latest, macos-15-intel]
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install package from TestPyPI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip --no-cache-dir install \
            --index-url https://test.pypi.org/simple/ \
            --extra-index-url https://pypi.org/simple nest-simulator

      - name: Test NEST with macOS architecture info
        run: |
          python3 -c "
          import nest
          import platform
          import sys

          print(f'NEST {nest.__version__} on {platform.system()} {platform.release()}')
          print(f'Architecture: {platform.machine()}')
          print(f'Python: {sys.version}')

          # Test kernel and basic functionality
          nest.ResetKernel()
          print('✓ Kernel reset successful')

          # Test neuron creation
          neurons = nest.Create('iaf_psc_alpha', 8)
          print(f'✓ Created {len(neurons)} neurons')

          # Test devices
          vm = nest.Create('voltmeter')
          sg = nest.Create('spike_generator', params={'spike_times': [15.0, 35.0]})
          print('✓ Created devices')

          # Test connections and simulation
          nest.Connect(sg, neurons)
          nest.Connect(vm, neurons[:4])
          nest.Simulate(60.0)

          events = vm.events
          print(f'✓ Simulation complete: {len(events[\"times\"])} measurements')

          # Test Sonata on macOS (should be available)
          try:
              import nest.lib.hl_api_sonata
              print('✓ Sonata support: AVAILABLE (expected on macOS)')
          except ImportError:
              print('❌ Sonata support: NOT AVAILABLE (unexpected on macOS)')

          print(f'All macOS tests passed on {platform.machine()}!')
          "

  test_linux_distros:
    name: Test on different Linux distributions
    needs: [upload_pypi]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro: [
          "alpine:3.19", "alpine:3.18",
          "debian:12", "debian:11",
          "fedora:39", "fedora:38",
          "ubuntu:24.04", "ubuntu:22.04",
          "archlinux:latest"
        ]
    steps:
      - name: Test on ${{ matrix.distro }}
        run: |
          docker run --rm ${{ matrix.distro }} sh -c '
            # Install Python and pip based on distro
            if command -v apk >/dev/null 2>&1; then
              # Alpine
              apk add --no-cache python3 py3-pip
              PIP_CMD="pip3"
            elif command -v apt-get >/dev/null 2>&1; then
              # Debian/Ubuntu
              apt-get update && apt-get install -y python3 python3-pip
              PIP_CMD="pip3"
            elif command -v dnf >/dev/null 2>&1; then
              # Fedora
              dnf install -y python3 python3-pip
              PIP_CMD="pip3"
            elif command -v pacman >/dev/null 2>&1; then
              # Arch Linux
              pacman -Sy --noconfirm python python-pip
              PIP_CMD="pip"
            else
              echo "Unsupported package manager"
              exit 1
            fi

            # Install package from TestPyPI
            $PIP_CMD install --no-cache-dir \
              --index-url https://test.pypi.org/simple/ \
              --extra-index-url https://pypi.org/simple nest-simulator

            # Comprehensive NEST functionality tests
            python3 -c "
            import nest
            print(f'NEST {nest.__version__} on ${{ matrix.distro }}')

            # Test kernel reset
            nest.ResetKernel()
            print('✓ Kernel reset successful')

            # Test neuron creation and basic models
            neurons = nest.Create('iaf_psc_alpha', 5)
            print(f'✓ Created neurons: {neurons}')

            # Test device creation
            vm = nest.Create('voltmeter')
            sg = nest.Create('spike_generator', params={'spike_times': [10.0]})
            print('✓ Created devices')

            # Test connections
            nest.Connect(sg, neurons[0])
            nest.Connect(vm, neurons)
            print('✓ Network connections OK')

            # Test short simulation
            nest.Simulate(25.0)
            events = vm.events
            print(f'✓ Simulation complete: {len(events[\\\"times\\\"])} recordings')

            # Test Sonata support detection
            try:
                import nest.lib.hl_api_sonata
                print('✓ Sonata support: AVAILABLE')
            except ImportError:
                print('- Sonata support: NOT AVAILABLE')

            print('All tests passed on ${{ matrix.distro }}!')
            "
          '
